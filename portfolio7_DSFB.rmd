# Portfolio assignment 7

```{r}
source(here("src/port_src7.R"))
```

**1. Load the flu (“./data/flu_data.csv), the dengue (.”/data/dengue_data.csv) and the gapminder ({dslabs} package) into three separate dataframes in R.**

```{r}
dengue <- read.csv(here::here("7_data/dengue_data.txt"), skip = 11) 
head(dengue)

flu <- read.csv(here::here("7_data/flu_data.txt"), skip = 11)
head(flu)

head(gapminder)
```

**2. Check if they are in the right shape. Is the data in the ‘tidy’ format? If not change the format to ‘tidy’**

```{r 7.2}
dengue <- dengue %>% pivot_longer(Argentina:Venezuela, names_to = "country", values_to = "value")
head(dengue)

flu <- flu %>% pivot_longer(Argentina:Uruguay, names_to = "country", values_to = "value")
head(flu)

```


**3. Change the country and date variables of the three tables so that they coincide in terms of data type, class and values**

```{r 7.3}
dengue <- dengue %>% separate("Date", into = c("year", "month", "day"), sep = "-") 

dengue <- dengue[-c(2,3)] 
dengue$year <- as.integer(dengue$year)
dengue$country <- as.factor(dengue$country)

dengue <- dengue %>% 
            group_by(year, country) %>% 
            summarise("country" = country, "dengue_activity" = sum(value, na.rm = T)) %>%
            unique()

head(dengue)


flu <- flu %>% separate("Date", into = c("year", "month", "day"), sep = "-") 

flu <- flu[-c(2,3)] 
flu$year <- as.integer(flu$year)
flu$country <- as.factor(flu$country)

flu <- flu %>% 
        group_by(year, country) %>% 
        summarise("country" = country, "influenza_activity" = sum(value, na.rm = T)) %>%
        unique()

head(flu)
```

**4. Store the three tables as separate (so six in total) .csv and .rds files.**

```{r, eval=F}
for (x in c("flu", "dengue", "gapminder")) {
  export(get(x), path = paste0(here("7_data//"), x))
}

```


**5. In Dbeaver create a new PostgreSQL database “workflowsdb”**

```{r, fig.cap = "The workflows database in Dbeaver."}
knitr::include_graphics(here("7_data/workflowsdb_in_Dbeaver.JPG"))
```

![Workflows database in DBeaver](/)

**6. Using RPostgreSQL, insert the tables into the database.**

```{r}
psswd <- .rs.askForPassword("Database Password:")

con <- dbConnect(RPostgres::Postgres(), 
                 dbname = "workflowsdb", 
                 host="localhost", 
                 port="5432", 
                 user="postgres", 
                 password=psswd)
```

```{r, eval=FALSE}
dbWriteTable(con, "dengueDB", dengue, overwrite = T)
dbWriteTable(con, "fluDB", flu, overwrite = T)
dbWriteTable(con, "gapminderDB", gapminder, overwrite = T)
````


**7. Inspect the contents of the tables with SQL (in DBeaver) and save the SQL script.**

```{sql connection= con}
SELECT *  FROM "dengueDB";
```

```{sql connection= con}
SELECT *  FROM "fluDB";
```

```{sql connection= con}
SELECT *  FROM "gapminderDB";
```

**8. Inspect the contents of the tables with dplyr (in R) and save a RMarkdown showing what you are doing.**

```{r}
db_names <- c("fluDB", "dengueDB", "gapminderDB")

tables <- list()
for (i in db_names){
   tables[[paste(i)]] <- dbReadTable(con, i)
}
```

```{r 7.8 inspection}
general_inspection(tables$fluDB, tables$fluDB$year, tables$fluDB$influenza_activity)
general_inspection(tables$dengueDB, tables$dengueDB$year, tables$dengueDB$dengue_activity)
general_inspection(tables$gapminderDB)
```


**9. Load the gapminder data in R and change the dataframe in such as way that you could join it to dengue and flue.**

```{r}
tables$fluDB$year %>% unique()
tables$dengueDB$year %>% unique()
```
The data of `flu` and `dengue` are from the year 2002 untill 2015. while the data of gapminder is from:

```{r}
tables$gapminderDB$year %>% unique()
```
1960 till 2015. we've also seen in 7.8 that the flu data has 406 rows while the dengue data has 140 rows. 

```{r}
amount_factor(tables$fluDB$country)
amount_factor(tables$dengueDB$country)
amount_factor(tables$gapminderDB$country)

```

```{r}
levelF <- tables$fluDB$country %>% as.factor %>% levels()
levelD <- tables$dengueDB$country %>% as.factor %>% levels()
levelG <- tables$gapminderDB$country %>% as.factor %>% levels()

common(levelD, levelG)
```
All the countries in the dengue data set are all also in the gapminder dataset.

```{r}
common(levelD, levelF)
common(levelF, levelG) %>% length()
```
but the flu data set only has `r common(levelD, levelF)` in common with the dengue data set.



If the tables are to be joined they need to have data about only the countries and years equal to the counties and years that the tables have in common. Or the tables need to be joined in a way that `NA` is introduced where necessary.

```{r}
gapminder_02_15 <- tables$gapminderDB %>% filter(between(year, 2002, 2015))
```

**10. Save this clean gapminder data in the “workflowsdb” database**

```{r, eval=FALSE}
dbWriteTable(con, "gapminder_02_15DB", gapminder_02_15, overwrite = T)
```


**11. Perform some joins (your choice) with SQL (can be done in DBeaver or with dplyr).**

```{sql connection = con}
SELECT "gapminder_02_15DB".*, "fluDB".influenza_activity, "dengueDB".dengue_activity 
FROM "gapminder_02_15DB"
LEFT JOIN "fluDB" ON public."fluDB".year = public."gapminder_02_15DB".year 
AND public."fluDB".country = public."gapminder_02_15DB".country
LEFT JOIN "dengueDB" ON public."dengueDB".year = public."gapminder_02_15DB".year
AND public."dengueDB".country = public."gapminder_02_15DB".country
```

**12. Generate a joined table, and export this from the database to R.**

```{sql connection = con, eval = F}
CREATE TABLE joined_gapfluden 
AS SELECT "gapminder_02_15DB".*, "fluDB".influenza_activity, "dengueDB".dengue_activity 
FROM "gapminder_02_15DB"
LEFT JOIN "fluDB" ON public."fluDB".year = public."gapminder_02_15DB".year 
AND public."fluDB".country = public."gapminder_02_15DB".country
LEFT JOIN "dengueDB" ON public."dengueDB".year = public."gapminder_02_15DB".year
AND public."dengueDB".country = public."gapminder_02_15DB".country
```


```{r}
joined_gapfluden <- dbReadTable(conn = con, "joined_gapfluden")
```

```{r, eval=FALSE}
dbDisconnect(con)
```

**13. Show some descriptive statistics with this table, and at least 3 visualizations using ggplot2.**

The joined dataset contains data about `R joined_gapfluden["country"] %>% unique() %>% count() %>% pull()` different countries, during the time period from `R joined_gapfluden["year"] %>% min` until `R joined_gapfluden["year"] %>% max`. And also the influenza cases per country during this time.

```{r}
joined_gapfluden$country <- joined_gapfluden$country %>% as.factor()
joined_gapfluden$year <- joined_gapfluden$year %>% as.factor()
joined_gapfluden$continent <- joined_gapfluden$continent %>% as.factor()
joined_gapfluden$region <- joined_gapfluden$region %>% as.factor()
```

```{r}
kableExtra::kable(head(joined_gapfluden))
```

Influenza, commonly called the flu, is an infectious disease caused by The influenza virus. Symptoms can be quite mild; fever, runny nose, sore throat. Or severe pneumonia.

in 2009 a strain of influenza, the H1N1 influenza strain caused a pandemic known as the swine flu.

```{r}
joined_gapfluden %>% 
  ggplot(aes(x= year, y = influenza_activity, group = country, fill = country)) +
  geom_area(alpha = 0.7, size = 0.4, colour = "white") +
  theme_ipsum() + #or theme_ft_rc()
  scale_fill_viridis(discrete = T)
```

Global cases peaked in 2009 at `r joined_gapfluden %>% group_by(year) %>% summarise(global_influenza_cases = sum(influenza_activity, na.rm = T)) %>% pull() %>% max() `.

Some countries had more influenza cases realtive to their population during the peak than others.

```{r}
relative_influenza_2009 <- joined_gapfluden %>% 
  filter(continent == "Europe", year == "2009") %>% 
  select(country, population, influenza_activity) %>% 
  mutate(relative_influenza_cases = (influenza_activity / population)*100)

regions <- relative_influenza_2009$country
#remove Russia because it takes up too much space in the map
regions <- regions[-11]

map_data_eu <- map_data("world", region = regions)

relative_influenza_2009 <- relative_influenza_2009 %>% filter(country != "Russia")
#renaming for left join
relative_influenza_2009 <- rename(relative_influenza_2009, region = country)
map_data_eu <- left_join(relative_influenza_2009, map_data_eu, by = "region")

ggplot(map_data_eu, aes(x = long, y = lat)) +
  geom_polygon(aes(group = group, fill = relative_influenza_cases), colour = "white", size = 0.1) +
  theme_void() + #maybe a dark theme?
  scale_fill_viridis(option = "E") + 
  labs(title = "Influenza Activity in europe",
       fill = "relative influenza activity")
  
```

It is visible that Austria was had a relatively high influenza activity. Could this have effected life expectancy in Austria?

```{r}
joined_gapfluden %>%
  filter(country == "Austria") %>%
  ggplot() +
  geom_line(aes(x = year, y = life_expectancy), group = 1, size = 1) +
  geom_line(aes(x = year, y = influenza_activity/500), group = 1, inherit.aes = F, size = 1, color = "red") +
  scale_y_continuous(
    name = "Life Expectancy in years",
    sec.axis = sec_axis(~.*500, name = "Influenza cases")
  ) +
  theme_ipsum()
  
```


